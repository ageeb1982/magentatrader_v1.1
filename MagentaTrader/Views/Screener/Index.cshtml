@{
    //ViewBag.Title = "Index";

    var Version = "v.Beta.1.20150502";
}

<link href="/wijmo/styles/wijmo.min.css" rel="stylesheet" />
<script src="/js/jquery-1.10.2.min.js"></script>
<script src="/js/knockout-3.2.0.js"></script>
<script src="/wijmo/controls/wijmo.min.js" type="text/javascript"></script>
<script src="/wijmo/controls/wijmo.grid.min.js" type="text/javascript"></script>

<nav class="navbar navbar-default navbar-fixed-top topnav" role="navigation">
    <div class="container topnav">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand topnav" href="/Home"><span><img src="/img/logo-1.png" /></span><span class="hidden-xs"> - Screener @Version</span></a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <h2 class="section-heading">Screener</h2>
        <div class="col-lg-2">
            <p>Exchange</p>
            <select id="Exchange" class="form-control">
                <option value="All">All</option>
                <option value="NASDAQ">NASDAQ</option>
                <option value="NYSE">NYSE</option>
            </select>
        </div>
        <div class="col-lg-2">
            <p>Price</p>
            <input type="text" class="form-control" id="ClosePrice" placeholder="Price - [US $10]">
        </div>
        <div class="col-lg-2">
            <p>Volume</p>
            <input type="text" class="form-control" id="Volume" placeholder="Volume - [1M]">
        </div>
        <div class="col-lg-2">
            <p>Growth(Decay) Rate</p>
            <input type="text" class="form-control" id="GrowthDecayRate" placeholder="Growth(Decay) - [100]">
        </div>
        <div class="col-lg-2">
            <p>Growth(Decay) Time</p>
            <select id="GrowthDecayTime" class="form-control">
                <option value="C0">Current Trend</option>
                <option value="W1">One Week</option>
                <option value="W2">Two Weeks</option>
                <option value="W3">Three Weeks</option>
                <option value="M1">One Month</option>
                <option value="M2">Two Months</option>
                <option value="M3">Three Months</option>
            </select>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-lg-2">
            <button id="CmdGetResult" type="submit" class="btn btn-primary btn-block" onclick="CmdGetResult_OnClick()">Get Result</button>
        </div>
        <div class="col-lg-2">
            <button id="CmdSaveXLS" type="submit" class="btn btn-primary btn-block" onclick="CmdSaveXLS_OnClick()">Save Result</button>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-lg-12">
            <div id="ScreenerGrid" class="grid"></div>
            <div class="row">
                <div class="btn-group col-md-7" id="naviagtionPageEvent">
                    <button type="button" class="btn btn-default" id="btnMoveToFirstPageEvent">
                        <span class="glyphicon glyphicon-fast-backward"></span>
                    </button>
                    <button type="button" class="btn btn-default" id="btnMoveToPreviousPageEvent">
                        <span class="glyphicon glyphicon-step-backward"></span>
                    </button>
                    <button type="button" class="btn btn-default" disabled style="width:100px" id="btnCurrentPageEvent"></button>
                    <button type="button" class="btn btn-default" id="btnMoveToNextPageEvent">
                        <span class="glyphicon glyphicon-step-forward"></span>
                    </button>
                    <button type="button" class="btn btn-default" id="btnMoveToLastPageEvent">
                        <span class="glyphicon glyphicon-fast-forward"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <br />
</div>

<div class="modal fade" id="loading" tabindex="-1" role="dialog" aria-labelledby="Loading..." aria-hidden="true">
    <div class="modal-dialog" style="width: 220px;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Loading...</h4>
            </div>
            <div class="modal-body">
                <img src="/img/progress_bar.gif" />
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var ScreenerData;
    var ScreenerGrid;

    var ScreenerSaveData = [];

    var btnFirstPageEvent;
    var btnPreviousPageEvent;
    var btnNextPageEvent;
    var btnLastPageEvent;
    var btnCurrentPageEvent;

    function GetRateColor(Rate) {
        var GreenColor = "#0FB203";
        var RedColor = "#A80008";
        return Rate >= 0 ? GreenColor : RedColor;
    }
    function GetRate(GrowthDecayTime, Result) {
        var returnResult = 0;
        switch (GrowthDecayTime) {
            case "C0":
                returnResult = Result.GrowthDecayRate;
                break;
            case "W1":
                returnResult = Result.GrowthDecayRateW1;
                break;
            case "W2":
                returnResult = Result.GrowthDecayRateW2;
                break;
            case "W3":
                returnResult = Result.GrowthDecayRateW3;
                break;
            case "M1":
                returnResult = Result.GrowthDecayRateM1;
                break;
            case "M2":
                returnResult = Result.GrowthDecayRateM2;
                break;
            case "M3":
                returnResult = Result.GrowthDecayRateM3;
                break;
            default:
                returnResult = 0;
                break;
        }
        return Math.round(returnResult);
    }
    function GetData(Exchange, Price, Volume, GrowthDecayRate, GrowthDecayTime) {
        $('#loading').modal('show');
        var d = new wijmo.collections.ObservableArray();
        $.ajax({
            url: '/api/SymbolScreener/' + Exchange + '/' + Price + '/' + Volume + '/' + GrowthDecayRate + '/' + GrowthDecayTime,
            type: 'GET',
            dataType: 'json',
            success: function (result) {
                for (i = 0; i < result.length; i++) {
                    d.push({
                        Symbol: "<a  href='/Software?symbol=" + result[i].SymbolDescription + "' target='_blank'>" + result[i].SymbolDescription + "</a>",
                        SymbolRaw: result[i].SymbolDescription,
                        Description: result[i].Description,
                        Exchange: result[i].Exchange,
                        ClosePrice: result[i].ClosePrice,
                        Volume: result[i].Volume,
                        Rate: GetRate(GrowthDecayTime, result[i]),
                        GrowthDecayRate: Math.round(result[i].GrowthDecayRate),
                        GrowthDecayRateW1: Math.round(result[i].GrowthDecayRateW1),
                        GrowthDecayRateW2: Math.round(result[i].GrowthDecayRateW2),
                        GrowthDecayRateW3: Math.round(result[i].GrowthDecayRateW3),
                        GrowthDecayRateM1: Math.round(result[i].GrowthDecayRateM1),
                        GrowthDecayRateM2: Math.round(result[i].GrowthDecayRateM2),
                        GrowthDecayRateM3: Math.round(result[i].GrowthDecayRateM3),
                        NoOfYears: result[i].NoOfYears
                    });
                }

                while (ScreenerSaveData.length > 0) ScreenerSaveData.pop();
                ScreenerSaveData = d;

                ScreenerData = new wijmo.collections.CollectionView(d);               
                ScreenerData.pageSize = 15;
                $('#loading').modal('hide');
                MakeScreenerGrid();
            },
            statusCode: {
                404: function () {
                    alert('Failed');
                    $('#loading').modal('hide');
                }
            }
        });
    }
    function UpdateNavigateButtonsEvent() {
        if (ScreenerData.pageSize <= 0) {
            document.getElementById('naviagtionPageEvent').style.display = 'none';
            return;
        }
        document.getElementById('naviagtionPageEvent').style.display = 'block';
        if (ScreenerData.pageIndex === 0) {
            btnFirstPageEvent.setAttribute('disabled', 'disabled');
            btnPreviousPageEvent.setAttribute('disabled', 'disabled');
            btnNextPageEvent.removeAttribute('disabled');
            btnLastPageEvent.removeAttribute('disabled');
        }
        else if (ScreenerData.pageIndex === (ScreenerData.pageCount - 1)) {
            btnFirstPageEvent.removeAttribute('disabled');
            btnPreviousPageEvent.removeAttribute('disabled');
            btnLastPageEvent.setAttribute('disabled', 'disabled');
            btnNextPageEvent.setAttribute('disabled', 'disabled');
        }
        else {
            btnFirstPageEvent.removeAttribute('disabled');
            btnPreviousPageEvent.removeAttribute('disabled');
            btnNextPageEvent.removeAttribute('disabled');
            btnLastPageEvent.removeAttribute('disabled');
        }
        btnCurrentPageEvent.innerHTML = (ScreenerData.pageIndex + 1) + ' / ' + ScreenerData.pageCount;
    }
    function MakeScreenerGrid() {
        ScreenerGrid.dispose();
        ScreenerGrid = new wijmo.grid.FlexGrid('#ScreenerGrid');
        ScreenerGrid.initialize({
            columns: [
                        {
                            "header": "Symbol",
                            "binding": "Symbol",
                            "width": 80,
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        },{
                            "header": "Price",
                            "binding": "ClosePrice",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        },{
                            "header": "Volume",
                            "binding": "Volume",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        },{
                            "header": "Years",
                            "binding": "NoOfYears",
                            "width": 40,
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        },{
                            "header": "Rate-Trend",
                            "binding": "GrowthDecayRate",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }, {
                            "header": "Rate-W1",
                            "binding": "GrowthDecayRateW1",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }, {
                            "header": "Rate-W2",
                            "binding": "GrowthDecayRateW2",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }, {
                            "header": "Rate-W3",
                            "binding": "GrowthDecayRateW3",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }, {
                            "header": "Rate-M1",
                            "binding": "GrowthDecayRateM1",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }, {
                            "header": "Rate-M2",
                            "binding": "GrowthDecayRateM2",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }, {
                            "header": "Rate-M3",
                            "binding": "GrowthDecayRateM3",
                            "width": "9*",
                            "allowSorting": true,
                            "isContentHtml": true,
                            "wordWrap": true
                        }

            ],
            autoGenerateColumns: false,
            itemsSource: ScreenerData,
            isReadOnly: true,
            selectionMode: wijmo.grid.SelectionMode.Row,
            itemFormatter: function (panel, r, c, cell) {
                if (wijmo.grid.CellType.Cell == panel.cellType && 
                   (panel.columns[c].binding == 'GrowthDecayRate' || 
                    panel.columns[c].binding == 'GrowthDecayRateW1' || 
                    panel.columns[c].binding == 'GrowthDecayRateW2' ||
                    panel.columns[c].binding == 'GrowthDecayRateW3' ||
                    panel.columns[c].binding == 'GrowthDecayRateM1' ||
                    panel.columns[c].binding == 'GrowthDecayRateM2' ||
                    panel.columns[c].binding == 'GrowthDecayRateM3')) {
                    var cellData = panel.getCellData(r, c);
                    cell.style.color = GetRateColor(cellData);
                }
            }
        });
        ScreenerGrid.trackChanges = true;

        btnFirstPageEvent = document.getElementById('btnMoveToFirstPageEvent');
        btnPreviousPageEvent = document.getElementById('btnMoveToPreviousPageEvent');
        btnNextPageEvent = document.getElementById('btnMoveToNextPageEvent');
        btnLastPageEvent = document.getElementById('btnMoveToLastPageEvent');
        btnCurrentPageEvent = document.getElementById('btnCurrentPageEvent');

        UpdateNavigateButtonsEvent();

        btnFirstPageEvent.addEventListener('click', function () {
            ScreenerData.moveToFirstPage();
            UpdateNavigateButtonsEvent();
        });
        btnPreviousPageEvent.addEventListener('click', function () {
            ScreenerData.moveToPreviousPage();
            UpdateNavigateButtonsEvent();
        });
        btnNextPageEvent.addEventListener('click', function () {
            ScreenerData.moveToNextPage();
            UpdateNavigateButtonsEvent();
        });
        btnLastPageEvent.addEventListener('click', function () {
            ScreenerData.moveToLastPage();
            UpdateNavigateButtonsEvent();
        });
    }

    function CmdGetResult_OnClick() {
        var $exchange = document.getElementById('Exchange').value;
        var $closePrice = parseFloat(document.getElementById('ClosePrice').value);
        var $volume = parseFloat(document.getElementById('Volume').value);
        var $growthDecayRate = parseFloat(document.getElementById('GrowthDecayRate').value);
        var $growthDecayTime = document.getElementById('GrowthDecayTime').value;
        
        $closePrice = !$closePrice ? 10 : $closePrice;
        $volume = !$volume ? 1000000 : $volume;
        $growthDecayRate = !$growthDecayRate ? 100 : $growthDecayRate;
        $growthDecayTime = !$growthDecayTime ? "C0" : $growthDecayTime;

        GetData($exchange, $closePrice, $volume, $growthDecayRate, $growthDecayTime);
    }
    function CmdSaveXLS_OnClick() {
        var CSV = '';
        var screener = [];

        for (i = 0; i < ScreenerSaveData.length; i++) {
            screener.push({
                Symbol: ScreenerSaveData[i].SymbolRaw,
                Description: ScreenerSaveData[i].Description,
                Exchange: ScreenerSaveData[i].Exchange,
                ClosePrice: ScreenerSaveData[i].ClosePrice,
                Volume: ScreenerSaveData[i].Volume,
                NoOfYears: ScreenerSaveData[i].NoOfYears,
                GrowthDecayRate: ScreenerSaveData[i].GrowthDecayRate,
                GrowthDecayRateW1: ScreenerSaveData[i].GrowthDecayRateW1,
                GrowthDecayRateW2: ScreenerSaveData[i].GrowthDecayRateW2,
                GrowthDecayRateW3: ScreenerSaveData[i].GrowthDecayRateW3,
                GrowthDecayRateM1: ScreenerSaveData[i].GrowthDecayRateM1,
                GrowthDecayRateM2: ScreenerSaveData[i].GrowthDecayRateM2,
                GrowthDecayRateM3: ScreenerSaveData[i].GrowthDecayRateM3
            });
        }

        CSV += 'Screener Data' + '\r\n\n';

        var screenerLabelRow = '';
        for (var s in screener[0]) {
            screenerLabelRow += s + ',';
        }
        screenerLabelRow = screenerLabelRow.slice(0, -1);
        CSV += screenerLabelRow + '\r\n';

        for (var i = 0; i < screener.length; i++) {
            var screenerRow = '';
            for (var s in screener[i]) {
                screenerRow += '"' + screener[i][s] + '",';
            }
            screenerRow.slice(0, screenerRow.length - 1);
            CSV += screenerRow + '\r\n';
        }

        if (CSV == '') {
            alert("No data");
            return;
        }

        // Create filename

        var $exchange = parseInt(document.getElementById('Exchange').value);
        var $closePrice = parseInt(document.getElementById('ClosePrice').value);
        var $volume = parseInt(document.getElementById('Volume').value);
        var $growthdecayrate = parseInt(document.getElementById('GrowthDecayRate').value);
        var $growthdecaytime = document.getElementById('GrowthDecayTime').value;

        $exchange = !$exchange ? "All" : $exchange;
        $closePrice = !$closePrice ? 10 : $closePrice;
        $volume = !$volume ? 1000000 : $volume;
        $growthdecayrate = !$growthdecayrate ? 100 : $growthdecayrate;
        $growthdecaytime = !$growthdecaytime ? "C0" : $growthdecaytime;

        var fileName = 'magenta_screener_' + $exchange + '_' + $closePrice + '_' + $volume + '_' + $growthdecayrate + '_' + $growthdecaytime + '.CSV';

        // Download via <a> link

        var link = document.createElement("a");

        if (link.download !== undefined) {
            var blob = new Blob([CSV], { type: 'text/csv;charset=utf-8;' });
            var url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style = "visibility:hidden";
        }

        if (navigator.msSaveBlob) {
            link.addEventListener("click", function (event) {
                var blob = new Blob([CSV], {
                    "type": "text/csv;charset=utf-8;"
                });
                navigator.msSaveBlob(blob, fileName);
            }, false);
        }

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

    }

    $(document).ready(function () {
        ScreenerGrid = new wijmo.grid.FlexGrid('#ScreenerGrid');
    });
</script>

<script src="/lib/jquery/js/jquery.js"></script>
<script src="/lib/bootstrap/js/bootstrap.js"></script>
<script src="/wijmo/controls/wijmo.input.min.js"></script>
<script src="/wijmo/interop/knockout/wijmo.knockout.min.js"></script>
