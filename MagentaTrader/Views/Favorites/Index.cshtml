@{
    ViewBag.Title = "Index";
}

<link href="/css/bootstrap.min.css" rel="stylesheet" />
<link href="/css/styles.css" rel="stylesheet" />

<script src="/js/jquery.js"></script>
<script src="/lib/bootstrap/js/bootstrap.js"></script>

<script src="/js/date.js"></script>

<script src="/wijmo/controls/wijmo.min.js" type="text/javascript"></script>
<script src="/wijmo/controls/wijmo.input.min.js"></script>
<script src="/wijmo/controls/wijmo.grid.min.js" type="text/javascript"></script>
<script src="/wijmo/controls/wijmo.chart.min.js"></script>

<link href="/wijmo/styles/wijmo.min.css" rel="stylesheet" />

<nav class="navbar navbar-default navbar-fixed-top topnav" role="navigation">
    <div class="container topnav">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand topnav" href="/Home"><span><img src="/img/logo-1.png" /></span><span class="hidden-xs"></span></a>
        </div>
    </div>
</nav>

<div class="container">
    <div class="row">
        <div class="col-lg-11">
            <h4>Favorites</h4>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-lg-4">
            <h4 id="FavoriteCode"></h4>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="col-lg-4">
            <div class="input-group">
                <span class="input-group-btn">
                    <button class="btn btn-default" type="button"><span class="fa fa-search"></span></button>
                </span>
                <input type="text" class="form-control" id="InputFilter" placeholder="Search...">
            </div>
        </div>
        <div class="col-lg-8">
            <button id="CmdAddFavorites" type="submit" class="btn btn-primary pull-right" onclick="CmdFavoritesAdd_OnClick()">
                Add
            </button>
            <button id="CmdDownloadFavorites" class="btn btn-primary pull-right" style="margin-right: 10px;" onclick="CmdFavoritesDownload_OnClick()">
                Download
            </button> 
            <label class="btn btn-primary pull-right" for="CmdUploadFavorites" style="margin-right: 10px;">
                <input id="CmdUploadFavorites" type="file" style="display:none;">
                Upload
            </label>
        </div>
        </div>
    <br />
    <div class="row">
        <div class="col-lg-12">
            <div id="FavoritesGrid" class="grid"></div>
        </div>
    </div>
    <br />
    <div class="row">
        <div class="btn-group col-md-7" id="navigationButton">
            <button type="button" class="btn btn-default" id="navMoveToFirst">
                <span class="glyphicon glyphicon-fast-backward"></span>
            </button>
            <button type="button" class="btn btn-default" id="navMoveToPrevious">
                <span class="glyphicon glyphicon-step-backward"></span>
            </button>
            <button type="button" class="btn btn-default" disabled style="width:100px" id="navMoveToCurrent"></button>
            <button type="button" class="btn btn-default" id="navMoveToNext">
                <span class="glyphicon glyphicon-step-forward"></span>
            </button>
            <button type="button" class="btn btn-default" id="navMoveToLast">
                <span class="glyphicon glyphicon-fast-forward"></span>
            </button>
        </div>
    </div>
</div>

@*Loading*@
<div class="modal fade" id="loading" tabindex="-1" role="dialog" aria-labelledby="Loading..." aria-hidden="true">
    <div class="modal-dialog" style="width: 220px;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Loading...</h4>
            </div>
            <div class="modal-body">
                <img src="/img/progress_bar.gif" />
            </div>
        </div>
    </div>
</div>

@*Edit Detail*@
<div class="modal fade" id="FavoritesEdit">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title">Favorites Edit</h4>
            </div>
            <div class="modal-body">
                <dl class="dl-horizontal">
                    <dt>Symbol</dt>
                    <dd>
                        <input class="form-control" id="FavoritesEdit_Id" type="hidden" />
                        <input class="form-control" id="FavoritesEdit_Symbol" type="text" />
                    </dd>
                    <dt>Remarks</dt>
                    <dd>
                        <input class="form-control" id="FavoritesEdit_Remarks" type="text" />
                    </dd>
                </dl>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal" id="CmdFavoritesEditOk" onclick="CmdFavoritesEditOk_OnClick()">
                    Ok
                </button>
                <button type="button" class="btn btn-danger" data-dismiss="modal" id="CmdFavoritesEditCancel">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>

@*Module*@
<script type="text/javascript">
    var Favorites;
    var FavoritesGrid;
    var FavoritesData;

    function GetFavorites() {
        var favorites = new wijmo.collections.ObservableArray();
        $('#loading').modal('show');
        $.ajax({
            url: '/api/UserFavorites',
            cache: false,
            type: 'GET',
            contentType: 'application/json; charset=utf-8',
            data: {},
            success: function (Results) {
                $('#loading').modal('hide');
                if (Results.length > 0) {
                    for (i = 0; i < Results.length; i++) {
                        favorites.push({
                            EditId: "<button class='btn btn-primary btn-xs' data-toggle='modal' id='CmdEditFavorites' onclick='CmdFavoritesEdit_OnClick()'>Edit</button>",
                            DeleteId: "<button class='btn btn-danger btn-xs' data-toggle='modal' id='CmdDeleteFavorites' onclick='CmdFavoritesDelete_OnClick()'>Delete</button>",
                            Id: Results[i]["Id"],
                            SymbolId: Results[i]["SymbolId"],
                            Symbol: Results[i]["Symbol"],
                            SymbolDescription: Results[i]["SymbolDescription"],
                            Exchange: Results[i]["Exchange"],
                            UserId: Results[i]["UserId"],
                            Remarks: Results[i]["Remarks"]
                        });
                    }
                    var favoriteCode = document.getElementById("FavoriteCode");
                    favoriteCode.innerHTML = "Your Favorite Code: " + favorites[0].UserId;
                } else {
                    alert("No data.");
                }
            }
        }).fail(
            function (xhr, textStatus, err) {
                alert(err);
            }
        );
        return favorites;
    }
    function CreateFavoritesGrid() {
        FavoritesData = GetFavorites();
        Favorites = new wijmo.collections.CollectionView(FavoritesData);
        Favorites.pageSize = 15;

        FavoritesGrid.dispose();
        FavoritesGrid = new wijmo.grid.FlexGrid('#FavoritesGrid');
        FavoritesGrid.initialize({
            columns: [
                        {
                            "header": "Edit",
                            "binding": "EditId",
                            "width": 60,
                            "allowSorting": false,
                            "isContentHtml": true
                        },
                        {
                            "header": "Delete",
                            "binding": "DeleteId",
                            "width": 60,
                            "allowSorting": false,
                            "isContentHtml": true
                        },
                        {
                            "header": "Symbol",
                            "binding": "Symbol",
                            "allowSorting": true,
                            "width": 80
                        },
                        {
                            "header": "Description",
                            "binding": "SymbolDescription",
                            "allowSorting": true,
                            "width": "2*"
                        },
                        {
                            "header": "Exchange",
                            "binding": "Exchange",
                            "allowSorting": true,
                            "width": 120
                        },
                        {
                            "header": "Remarks",
                            "binding": "Remarks",
                            "allowSorting": true,
                            "width": "2*"
                        }
            ],
            autoGenerateColumns: false,
            itemsSource: Favorites,
            isReadOnly: true,
            selectionMode: wijmo.grid.SelectionMode.Row
        });
        FavoritesGrid.trackChanges = true;
    }

    function CmdFavoritesAdd_OnClick() {
        $('#FavoritesEdit').modal({
            show: true,
            backdrop: false
        });

        document.getElementById('FavoritesEdit_Id').value = 0;
        document.getElementById('FavoritesEdit_Symbol').value = "";
        document.getElementById('FavoritesEdit_Remarks').value = "";
    }
    function CmdFavoritesEdit_OnClick() {
        Favorites.editItem(Favorites.currentItem);

        $('#FavoritesEdit').modal({
            show: true,
            backdrop: false
        });

        var EditFavorites = Favorites.currentEditItem;
        document.getElementById('FavoritesEdit_Id').value = EditFavorites.Id !== null && typeof (EditFavorites.Id) != 'undefined' ? wijmo.Globalize.format(EditFavorites.Id) : '';
        document.getElementById('FavoritesEdit_Symbol').value = EditFavorites.Symbol ? EditFavorites.Symbol : '';
        document.getElementById('FavoritesEdit_Remarks').value = EditFavorites.Remarks ? EditFavorites.Remarks : '';
    }
    function CmdFavoritesDelete_OnClick() {
        Favorites.editItem(Favorites.currentItem);

        var Id = Favorites.currentEditItem.Id;
        var Symbol = Favorites.currentEditItem.Symbol;

        if (confirm("Delete " + Symbol + "?") == true) {
            $.ajax({
                type: "DELETE",
                url: "/api/DeleteFavorite/" + Id,
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                statusCode: {
                    200: function () {
                        location.reload();
                    },
                    404: function () {
                        alert("Not found");
                    },
                    400: function () {
                        alert("Bad request");
                    }
                }
            });
        }
    }
    function CmdFavoritesEditOk_OnClick() {
        if (confirm("Save Favorites?") == true) {

            var Favorite = new Object();

            Favorite.Id = document.getElementById('FavoritesEdit_Id').value;
            Favorite.Symbol = document.getElementById('FavoritesEdit_Symbol').value.toUpperCase();
            Favorite.Remarks = document.getElementById('FavoritesEdit_Remarks').value;
            Favorite.User = '@User.Identity.Name';

            var data = JSON.stringify(Favorite);

            // Add New
            if (Favorite.Id == 0) {
                $.ajax({
                    type: "POST",
                    url: "/api/AddFavorite",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data,
                    success: function (id) {
                        if (id > 0) {
                            location.reload();
                        } else {
                            alert("Not added");
                        }
                    }
                });

                // Edit
            } else {
                $.ajax({
                    type: "PUT",
                    url: "/api/UpdateFavorite/" + Favorite.Id,
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: data,
                    statusCode: {
                        200: function () {
                            location.reload();
                        },
                        404: function () {
                            alert("Not found");
                        },
                        400: function () {
                            alert("Bad request");
                        }
                    }
                });
            }
        }
    }
    function CmdFavoritesDownload_OnClick() {
        var CSV = '';
        var symbols = [];
        var fileName = 'favoriteList.CSV';

        for (i = 0; i < FavoritesData.length; i++) {
            symbols.push({
                Symbol: FavoritesData[i].Symbol
            });
        }

        for (var i = 0; i < symbols.length; i++) {
            CSV += '"' + symbols[i].Symbol + '"\r\n';
        }

        if (CSV == '') {
            alert("No data");
        } else {
            var link = document.createElement("a");

            if (link.download !== undefined) {
                var blob = new Blob([CSV], { type: 'text/csv;charset=utf-8;' });
                var url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style = "visibility:hidden";
            }

            if (navigator.msSaveBlob) {
                link.addEventListener("click", function (event) {
                    var blob = new Blob([CSV], {
                        "type": "text/csv;charset=utf-8;"
                    });
                    navigator.msSaveBlob(blob, fileName);
                }, false);
            }

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    function updateNavigationButtons() {
        var Records = Favorites;
        if (Records.pageSize <= 0) {
            document.getElementById('navigationButton').style.display = 'none';
            return;
        }
        document.getElementById('navigationButton').style.display = 'block';
        if (Records.pageIndex === 0) {
            navMoveToFirst.setAttribute('disabled', 'disabled');
            navMoveToPrevious.setAttribute('disabled', 'disabled');
            navMoveToNext.removeAttribute('disabled');
            navMoveToLast.removeAttribute('disabled');
        }
        else if (Records.pageIndex === (Records.pageCount - 1)) {
            navMoveToFirst.removeAttribute('disabled');
            navMoveToPrevious.removeAttribute('disabled');
            navMoveToNext.setAttribute('disabled', 'disabled');
            navMoveToLast.setAttribute('disabled', 'disabled');
        }
        else {
            navMoveToFirst.removeAttribute('disabled');
            navMoveToPrevious.removeAttribute('disabled');
            navMoveToNext.removeAttribute('disabled');
            navMoveToLast.removeAttribute('disabled');
        }
        navMoveToCurrent.innerHTML = (Records.pageIndex + 1) + ' / ' + Records.pageCount;
    }
    function addNavigationListeners() {
        navMoveToFirst.addEventListener('click', function () {
            Favorites.moveToFirstPage();
            updateNavigationButtons();
        });
        navMoveToPrevious.addEventListener('click', function () {
            Favorites.moveToPreviousPage();
            updateNavigationButtons();
        });
        navMoveToNext.addEventListener('click', function () {
            Favorites.moveToNextPage();
            updateNavigationButtons();
        });
        navMoveToLast.addEventListener('click', function () {
            Favorites.moveToLastPage();
            updateNavigationButtons();
        });
    }

    $(document).ready(function () {
        FavoritesData = new wijmo.collections.ObservableArray();
        FavoritesGrid = new wijmo.grid.FlexGrid('#FavoritesGrid');
        CreateFavoritesGrid();
        updateNavigationButtons();
        addNavigationListeners();
        Favorites.collectionChanged.addHandler(function (sender, args) {
            updateNavigationButtons();
        });
        document.getElementById('CmdUploadFavorites').onchange = function () {
            var file = this.files[0];
            var reader = new FileReader();
            var data = [];
            var d = new wijmo.collections.ObservableArray();
            reader.onload = function (progressEvent) {
                var lines = this.result.split('\n');
                for (var line = 0; line < lines.length; line++) {
                    var buf = lines[line].replace(/['"]+/g, '');
                    data.push(buf.replace(/(\r\n|\n|\r)/gm, ""));
                    if (line === 399) { break; }
                }
                $.ajax({
                    url: '/api/UploadFavorites',
                    type: 'GET',
                    data: { Symbols: data },
                    traditional: true,
                    success: function (id) {
                        if (id > 0) {
                            location.reload();
                        } else {
                            alert("Unable to process upload.");
                        }
                    }
                });
            };
            reader.readAsText(file);
        };
    });
</script>



